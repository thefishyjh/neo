<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Fighter</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <a href="../../index.html" class="cyber-btn">&lt; SYSTEM_EXIT</a>

    <div class="game-wrapper">
        <div class="cyber-hud">
            <div class="hud-title">NEON_FIGHTER</div>
            <div class="hud-data">SCORE: <span id="score">0</span> | HP: <span id="hp">100</span>%</div>
        </div>
        <canvas id="gameCanvas" width="600" height="800"></canvas>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const scoreEl = document.getElementById("score");
        const hpEl = document.getElementById("hp");

        // --- Game State ---
        let score = 0;
        let hp = 100;
        let isGameOver = false;
        let isRunning = false;
        let frameCount = 0;

        // Player
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 40,
            height: 40,
            speed: 5,
            color: '#00f3ff',
            bullets: [],
            lastShot: 0,
            shootDelay: 10 // Frames between shots
        };

        // Enemies
        let enemies = [];
        const enemySpawnRate = 60; // Frames

        // Particles (Explosions)
        let particles = [];

        // Stars (Background)
        let stars = [];
        for(let i=0; i<50; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2 + 1,
                speed: Math.random() * 3 + 1
            });
        }

        // --- Input Handling ---
        // Mouse movement for smooth control
        canvas.addEventListener('mousemove', (e) => {
            if(!isRunning || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            player.x = e.clientX - rect.left;
            player.y = e.clientY - rect.top;
        });
        
        // Click to start
        canvas.addEventListener('click', () => {
            if(!isRunning && !isGameOver) {
                isRunning = true;
                gameLoop();
            }
        });

        // --- Game Logic ---

        function spawnEnemy() {
            const size = 40;
            const x = Math.random() * (canvas.width - size);
            enemies.push({
                x: x,
                y: -size,
                width: size,
                height: size,
                speed: Math.random() * 2 + 2,
                hp: 3
            });
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: color
                });
            }
        }

        function update() {
            if(isGameOver) return;

            frameCount++;

            // Background Stars
            stars.forEach(star => {
                star.y += star.speed;
                if(star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });

            // Player Shooting (Auto-fire)
            if(frameCount - player.lastShot > player.shootDelay) {
                player.bullets.push({
                    x: player.x,
                    y: player.y - player.height/2,
                    speed: 15,
                    width: 4,
                    height: 15
                });
                player.lastShot = frameCount;
            }

            // Update Bullets
            for(let i=player.bullets.length-1; i>=0; i--) {
                let b = player.bullets[i];
                b.y -= b.speed;
                if(b.y < 0) player.bullets.splice(i, 1);
            }

            // Update Enemies
            if(frameCount % enemySpawnRate === 0) spawnEnemy();

            for(let i=enemies.length-1; i>=0; i--) {
                let e = enemies[i];
                e.y += e.speed;

                // Collision: Enemy vs Player
                if (
                    player.x < e.x + e.width &&
                    player.x + player.width > e.x &&
                    player.y < e.y + e.height &&
                    player.y + player.height > e.y
                ) {
                    hp -= 20; // Take damage
                    hpEl.innerText = hp;
                    createExplosion(player.x, player.y, '#ff0000');
                    enemies.splice(i, 1);
                    if(hp <= 0) gameOver();
                    continue;
                }

                // Collision: Bullet vs Enemy
                for(let j=player.bullets.length-1; j>=0; j--) {
                    let b = player.bullets[j];
                    if (
                        b.x < e.x + e.width &&
                        b.x + b.width > e.x &&
                        b.y < e.y + e.height &&
                        b.y + b.height > e.y
                    ) {
                        // Hit!
                        player.bullets.splice(j, 1);
                        e.hp--;
                        createExplosion(b.x, b.y, '#ffff00');
                        if(e.hp <= 0) {
                            score += 100;
                            scoreEl.innerText = score;
                            createExplosion(e.x + e.width/2, e.y + e.height/2, '#ff00ff');
                            enemies.splice(i, 1);
                        }
                        break;
                    }
                }

                if(e.y > canvas.height) enemies.splice(i, 1);
            }

            // Update Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        // --- Rendering ---
        function draw() {
            // Clear
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'; // Trail effect
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Stars
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                ctx.globalAlpha = Math.random() * 0.5 + 0.5;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
            ctx.globalAlpha = 1.0;

            if(!isRunning) {
                ctx.fillStyle = "#00f3ff";
                ctx.font = "20px 'Courier New'";
                ctx.textAlign = "center";
                ctx.fillText("CLICK TO LAUNCH FIGHTER", canvas.width/2, canvas.height/2);
                return;
            }

            // Draw Player (Pixel Art Style)
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // Glow
            ctx.shadowBlur = 15;
            ctx.shadowColor = player.color;
            
            // Ship Body
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.moveTo(0, -20);
            ctx.lineTo(15, 20);
            ctx.lineTo(0, 10);
            ctx.lineTo(-15, 20);
            ctx.closePath();
            ctx.fill();
            
            // Engine Flame
            ctx.fillStyle = '#ff00ff';
            ctx.shadowColor = '#ff00ff';
            ctx.beginPath();
            ctx.moveTo(-5, 15);
            ctx.lineTo(5, 15);
            ctx.lineTo(0, 25 + Math.random()*10);
            ctx.fill();
            
            ctx.restore();

            // Draw Bullets
            ctx.fillStyle = '#ffff00'; // Yellow lasers
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ffff00';
            player.bullets.forEach(b => {
                ctx.fillRect(b.x - 2, b.y, b.width, b.height);
            });

            // Draw Enemies
            enemies.forEach(e => {
                ctx.save();
                ctx.translate(e.x + e.width/2, e.y + e.height/2);
                
                // Enemy shape
                ctx.fillStyle = '#ff0055';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#ff0055';
                
                // Simple Invader shape
                ctx.fillRect(-15, -15, 30, 30);
                ctx.fillStyle = '#000';
                ctx.fillRect(-5, -5, 10, 10); // Eye?

                ctx.restore();
            });

            // Draw Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.shadowBlur = 0;
                ctx.fillRect(p.x, p.y, 4, 4);
            });
            ctx.globalAlpha = 1.0;
        }

        function gameLoop() {
            if(isGameOver) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            isGameOver = true;
            ctx.fillStyle = 'rgba(0,0,0,0.85)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ff0000';
            ctx.font = 'bold 40px "Courier New"';
            ctx.textAlign = 'center';
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff0000';
            ctx.fillText("MISSION FAILED", canvas.width/2, canvas.height/2);
            
            saveGameResult("Neon Fighter", score, () => {
                 document.location.reload();
            });
        }
        
        // Initial Render
        draw();

        function saveGameResult(gameName, score, callback) {
            if (score <= 0) {
                if(callback) callback();
                return;
            }
            // Use the shared modal from main.js (needs to be loaded)
            if(window.showCyberPrompt) {
                showCyberPrompt("MISSION REPORT. PILOT ID:", (pilot) => {
                    const newScore = {
                        pilot: pilot.toUpperCase(),
                        game: gameName,
                        score: score,
                        date: new Date().toISOString()
                    };
                    const scores = JSON.parse(localStorage.getItem('neo_arcade_hall_of_fame') || '[]');
                    scores.push(newScore);
                    localStorage.setItem('neo_arcade_hall_of_fame', JSON.stringify(scores));
                    if(callback) callback();
                });
            } else {
                // Fallback if main.js isn't ready
                alert("Score Saved: " + score);
                if(callback) callback();
            }
        }

    </script>
    <script src="../../assets/js/main.js"></script>
</body>
</html>
